<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å˜èªãƒãƒƒãƒãƒ³ã‚°ï¼ˆè‹±â†’è‡ªå‹•å’Œè¨³â†’æ‰‹ç›´ã—â†’ã‚²ãƒ¼ãƒ ï¼‰</title>
  <style>
    :root{ --bd:#ddd; --muted:#666; }
    body{ font-family: system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; margin:18px; }
    h1{ font-size:20px; margin:0 0 10px; }
    .card{ border:1px solid var(--bd); border-radius:14px; padding:14px; margin:12px 0; }
    textarea{ width:100%; height:160px; font-size:14px; padding:10px; border-radius:12px; border:1px solid #ccc; }
    input, select{ padding:8px 10px; border-radius:10px; border:1px solid #ccc; }
    button{ padding:10px 14px; border-radius:12px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    button.primary{ border-color:#222; }
    button.danger{ border-color:#c62828; color:#c62828; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .split{ display:flex; gap:12px; flex-wrap:wrap; }
    .split > div{ flex:1 1 320px; }
    .muted{ color:var(--muted); font-size:13px; }
    .warn{ color:#c62828; font-size:13px; }
    .ok{ color:#2e7d32; font-size:13px; }
    .hidden{ display:none; }
    .pill{ display:inline-block; padding:2px 10px; border:1px solid var(--bd); border-radius:999px; font-size:12px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .colTitle{ font-weight:700; margin:4px 0 8px; }
    .list{ display:grid; gap:10px; }
    .tile{
      border:1px solid #ccc; border-radius:14px; padding:12px;
      background:#fff; text-align:left; user-select:none;
      display:flex; justify-content:space-between; align-items:center;
      min-height:48px;
    }
    .tile small{ color:var(--muted); }
    .tile.selected{ border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.06) inset; }
    .tile.matched{ border-color:#2e7d32; background:#f6fff7; opacity:.9; }
    .tile.wrong{ border-color:#c62828; background:#fff6f6; }
    .hud{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .bearWrap{ display:flex; gap:12px; align-items:center; }
    .bear{
      width:74px; height:74px; border-radius:18px;
      border:1px solid var(--bd);
      display:grid; place-items:center;
      font-size:44px;
      background:#fff;
    }
    .big{ font-size:18px; font-weight:700; }
    canvas#confetti{ position:fixed; inset:0; pointer-events:none; }
    .note{ font-size:12px; color:var(--muted); }
    .footerBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .mini{ padding:8px 10px; border-radius:10px; }
    .sep{ height:1px; background:var(--bd); margin:10px 0; }
  </style>
</head>
<body>
  <canvas id="confetti" class="hidden"></canvas>

  <h1>å˜èªãƒãƒƒãƒãƒ³ã‚°ï¼ˆè‹±èªâ†’æ—¥æœ¬èªï¼‰</h1>

  <!-- SETUP -->
  <div class="card" id="setupCard">

    <!-- âœ… ä¿å­˜æ¸ˆã¿ãƒªã‚¹ãƒˆæ“ä½œ -->
    <div class="row" style="margin-bottom:8px;">
      <label class="muted">ä¿å­˜æ¸ˆã¿ï¼š</label>
      <select id="savedSelect" style="min-width:260px;">
        <option value="">ï¼ˆãªã—ï¼‰</option>
      </select>
      <button class="mini" id="loadSavedBtn">èª­ã¿è¾¼ã¿</button>
      <button class="mini danger" id="deleteSavedBtn" disabled>å‰Šé™¤</button>
      <button class="mini" id="exportOneBtn" disabled>Exportï¼ˆã“ã®ãƒªã‚¹ãƒˆï¼‰</button>
      <button class="mini" id="exportAllBtn">Exportï¼ˆå…¨éƒ¨ï¼‰</button>
      <button class="mini" id="importBtn">Import</button>
      <input id="importFile" type="file" class="hidden" accept=".json,.txt" />
      <span class="muted" id="savedCount"></span>
    </div>

    <div class="sep"></div>

    <!-- âœ… æ—¢å­˜ï¼šæ‰‹å‹•ãƒªã‚¹ãƒˆå -->
    <div class="row" style="margin-bottom:8px;">
      <label class="muted">ãƒªã‚¹ãƒˆåï¼š</label>
      <input id="listNameInput" placeholder="ä¾‹ï¼šDay63 å‹•è© / æº–1ç´šâ‘ " style="min-width:260px;">
      <span class="muted">ï¼ˆã“ã®åå‰ã”ã¨ã«è‡ªå‹•ä¿å­˜ï¼‰</span>
    </div>

    <div class="split">
      <div>
        <p class="muted">
          1è¡Œã«1èªï¼ˆè‹±èªã ã‘ï¼‰ã‚’å…¥åŠ›ï¼ˆ10ã€œ15èªãŠã™ã™ã‚ï¼‰<br>
          ä¾‹ï¼š<span class="pill">compromise</span> <span class="pill">define</span>
        </p>
        <textarea id="enInput" placeholder="è‹±å˜èªã‚’ã“ã“ã«ï¼ˆ1è¡Œ1èªï¼‰"></textarea>

        <div class="row" style="margin-top:10px;">
          <button id="fetchBtn">æ—¥æœ¬èªã‚’è‡ªå‹•å–å¾—</button>
          <button class="primary" id="startBtn" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹</button>
          <button id="sampleBtn">ã‚µãƒ³ãƒ—ãƒ«</button>
        </div>

        <div class="muted" id="progress" style="margin-top:6px;"></div>
        <div class="warn" id="warn"></div>
        <div class="ok" id="ok"></div>

        <p class="note" style="margin-top:10px;">
          â€» ç¿»è¨³ã¯ãƒãƒƒãƒˆãŒå¿…è¦ã§ã™ã€‚å¤±æ•—ã—ãŸè¡Œã¯ç©ºæ¬„ã«ãªã‚‹ã®ã§ã€å³ã®ãƒªã‚¹ãƒˆã§æ‰‹ç›´ã—ã§ãã¾ã™ã€‚<br>
          â€» è‡ªå‹•ä¿å­˜ã¯ã€Œãƒªã‚¹ãƒˆåã€ãŒå…¥ã£ã¦ã„ã‚‹æ™‚ã ã‘åƒãã¾ã™ï¼ˆåå‰ãªã—ã§ã‚‚éŠã¹ã¾ã™ï¼‰ã€‚<br>
          â€» ç«¯æœ«å†…ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ãªã®ã§ã€åˆ¥ç«¯æœ«ãƒ»åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰ Export/Import ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
        </p>
      </div>

      <div>
        <p class="muted"><b>è‹±èª = æ—¥æœ¬èªï¼ˆã“ã“ã§æ‰‹ç›´ã—OKï¼‰</b></p>
        <textarea id="pairsArea" placeholder="è‡ªå‹•å–å¾—å¾Œã€ã“ã“ã«ã€Œè‹±èª = æ—¥æœ¬èªã€ãŒå…¥ã‚Šã¾ã™ï¼ˆæ‰‹ã§ç›´ã›ã¾ã™ï¼‰"></textarea>
        <div class="muted" style="margin-top:6px;">
          å½¢å¼ï¼š<code>word = æ—¥æœ¬èª</code>ï¼ˆ1è¡Œ1ã¤ï¼‰ï¼ã“ã“ã¯ãƒªã‚¹ãƒˆåã”ã¨ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™
        </div>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div class="card hidden" id="gameCard">
    <div class="hud">
      <div class="bearWrap">
        <div class="bear" id="bearFace" title="ãã¾">ğŸ˜</div>
        <div>
          <div class="big">ãƒãƒƒãƒãƒ³ã‚°</div>
          <div class="muted">
            æ­£è§£ <b id="score">0</b> / <span id="total">0</span>ã€€
            ãƒŸã‚¹ <b id="mistakes">0</b>
            <span class="pill" id="statePill">çœŸé¡”ãã¾</span>
          </div>
          <div class="muted" id="hint">è‹±èªã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ æ—¥æœ¬èªã‚’ã‚¯ãƒªãƒƒã‚¯</div>
        </div>
      </div>
      <div class="row">
        <button id="resetBtn">æœ€åˆã«æˆ»ã‚‹</button>
        <button id="shuffleBtn">ä¸¦ã¹ç›´ã™</button>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div>
        <div class="colTitle">è‹±èª</div>
        <div class="list" id="enList"></div>
      </div>
      <div>
        <div class="colTitle">æ—¥æœ¬èª</div>
        <div class="list" id="jaList"></div>
      </div>
    </div>

    <div class="footerBtns">
      <button class="primary" id="reviewWrongBtn" disabled>ã¾ã¡ãŒãˆãŸå˜èªã ã‘å¾©ç¿’ï¼ˆæœ€å¤§10ï¼‰</button>
      <button id="playAgainBtn">åŒã˜ã‚»ãƒƒãƒˆã§ã‚‚ã†ä¸€å›</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card hidden" id="resultCard">
    <div class="big">çµæœ</div>
    <p id="resultText" class="muted"></p>
    <div id="wrongBox" class="muted"></div>
    <div class="footerBtns">
      <button class="primary" id="retryWrongBtn" disabled>ã¾ã¡ãŒãˆãŸå˜èªã ã‘ï¼ˆæœ€å¤§10ï¼‰</button>
      <button id="retryAllBtn">å…¨éƒ¨ã‚‚ã†ä¸€å›</button>
      <button id="backBtn">å…¥åŠ›ã¸æˆ»ã‚‹</button>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const setupCard = $("setupCard");
  const gameCard = $("gameCard");
  const resultCard = $("resultCard");
  const confetti = $("confetti");

  const savedSelect = $("savedSelect");
  const savedCount = $("savedCount");
  const loadSavedBtn = $("loadSavedBtn");
  const deleteSavedBtn = $("deleteSavedBtn");
  const exportOneBtn = $("exportOneBtn");
  const exportAllBtn = $("exportAllBtn");
  const importBtn = $("importBtn");
  const importFile = $("importFile");

  const listNameInput = $("listNameInput");
  const enInput = $("enInput");
  const pairsArea = $("pairsArea");
  const fetchBtn = $("fetchBtn");
  const startBtn = $("startBtn");
  const sampleBtn = $("sampleBtn");
  const warn = $("warn");
  const ok = $("ok");
  const progress = $("progress");

  const enList = $("enList");
  const jaList = $("jaList");
  const scoreEl = $("score");
  const totalEl = $("total");
  const mistakesEl = $("mistakes");
  const bearFace = $("bearFace");
  const statePill = $("statePill");
  const hint = $("hint");

  const resetBtn = $("resetBtn");
  const shuffleBtn = $("shuffleBtn");
  const playAgainBtn = $("playAgainBtn");
  const reviewWrongBtn = $("reviewWrongBtn");

  const resultText = $("resultText");
  const wrongBox = $("wrongBox");
  const retryWrongBtn = $("retryWrongBtn");
  const retryAllBtn = $("retryAllBtn");
  const backBtn = $("backBtn");

  // âœ… è‡ªå‹•ä¿å­˜ï¼ˆåå‰ä»˜ãï¼‰
  const KEY_LAST = "fwe_last_list_name_v1";
  const PREFIX = "fwe_matching_list_v1_";   // â†å„ãƒªã‚¹ãƒˆã®ä¿å­˜ã‚­ãƒ¼ã®æ¥é ­è¾
  const keyFor = (name) => PREFIX + name;

  function saveLastName(name){
    localStorage.setItem(KEY_LAST, name);
  }

  function autoSavePairs(){
    const name = listNameInput.value.trim();
    if (!name) return; // åå‰ãŒç„¡ã„æ™‚ã¯ä¿å­˜ã—ãªã„ï¼ˆã§ã‚‚éŠã¹ã‚‹ï¼‰
    localStorage.setItem(keyFor(name), pairsArea.value);
    saveLastName(name);
    refreshSavedUI(name);
  }

  function loadPairsByName(name){
    if (!name) return null;
    return localStorage.getItem(keyFor(name));
  }

  function listSavedNames(){
    const names = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (!k) continue;
      if (k.startsWith(PREFIX)){
        const name = k.slice(PREFIX.length);
        if (name) names.push(name);
      }
    }
    names.sort((a,b) => a.localeCompare(b, "ja"));
    return names;
  }

  function setOk(msg){ ok.textContent = msg; warn.textContent = ""; }
  function setWarn(msg){ warn.textContent = msg; ok.textContent = ""; }

  function refreshSavedUI(preferName=""){
    const names = listSavedNames();
    const current = savedSelect.value;
    savedSelect.innerHTML = `<option value="">ï¼ˆãªã—ï¼‰</option>` + names.map(n => {
      const esc = escapeHtml(n);
      return `<option value="${esc}">${esc}</option>`;
    }).join("");

    // ä»¶æ•°è¡¨ç¤º
    savedCount.textContent = names.length ? `ä¿å­˜ ${names.length}ä»¶` : `ä¿å­˜ 0ä»¶`;

    // é¸æŠã‚’å¾©å…ƒï¼ˆå„ªå…ˆï¼špreferName â†’ current â†’ listNameInputï¼‰
    const want = preferName || current || listNameInput.value.trim();
    if (want && names.includes(want)){
      savedSelect.value = want;
    } else {
      savedSelect.value = "";
    }

    // ãƒœã‚¿ãƒ³æ´»æ€§
    const hasSel = !!savedSelect.value;
    deleteSavedBtn.disabled = !hasSel;
    exportOneBtn.disabled = !hasSel;
  }

  function applyLoaded(name, text){
    listNameInput.value = name || "";
    pairsArea.value = text || "";
    updateStartEnabled();
    if (name) saveLastName(name);
    refreshSavedUI(name);
  }

  function downloadText(filename, text, mime="text/plain"){
    const blob = new Blob([text], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportOne(name){
    const pairs = loadPairsByName(name);
    if (pairs == null){
      setWarn(`ã€Œ${name}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      refreshSavedUI();
      return;
    }
    const payload = {
      type: "fwe_matching_export_one_v1",
      exportedAt: new Date().toISOString(),
      name,
      pairsText: pairs
    };
    downloadText(`FWE_List_${safeFile(name)}.json`, JSON.stringify(payload, null, 2), "application/json");
    setOk(`Exportã—ã¾ã—ãŸï¼š${name}`);
  }

  function exportAll(){
    const names = listSavedNames();
    const lists = {};
    names.forEach(n => { lists[n] = localStorage.getItem(keyFor(n)) ?? ""; });
    const payload = {
      type: "fwe_matching_export_all_v1",
      exportedAt: new Date().toISOString(),
      count: names.length,
      lists
    };
    downloadText(`FWE_All_Lists.json`, JSON.stringify(payload, null, 2), "application/json");
    setOk(`å…¨éƒ¨Exportã—ã¾ã—ãŸï¼ˆ${names.length}ä»¶ï¼‰`);
  }

  function importPayload(obj, fallbackName=""){
    // 1ä»¶
    if (obj?.type === "fwe_matching_export_one_v1"){
      const name = String(obj.name || "").trim() || fallbackName;
      const pairsText = String(obj.pairsText || "");
      if (!name){
        setWarn("Importå¤±æ•—ï¼šãƒªã‚¹ãƒˆåãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      localStorage.setItem(keyFor(name), pairsText);
      applyLoaded(name, pairsText);
      setOk(`Importã—ã¾ã—ãŸï¼š${name}`);
      return;
    }
    // å…¨éƒ¨
    if (obj?.type === "fwe_matching_export_all_v1" && obj.lists && typeof obj.lists === "object"){
      const entries = Object.entries(obj.lists);
      entries.forEach(([name, pairsText]) => {
        const n = String(name || "").trim();
        if (!n) return;
        localStorage.setItem(keyFor(n), String(pairsText || ""));
      });
      refreshSavedUI();
      setOk(`Importã—ã¾ã—ãŸï¼ˆ${entries.length}ä»¶ï¼‰`);
      return;
    }
    setWarn("Importå¤±æ•—ï¼šã“ã®JSONå½¢å¼ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
  }

  function safeFile(name){
    return String(name).replace(/[\\/:*?"<>|]+/g, "_").slice(0, 80) || "list";
  }

  // Data
  let basePairs = [];        // full set
  let currentPairs = [];     // current game set
  let wrongPairs = [];       // pairs user got wrong at least once (unique)
  let mistakes = 0;
  let matched = 0;

  // Selection
  let selectedEN = null;
  let selectedJA = null;

  // ---------- helpers ----------
  function show(which){
    setupCard.classList.add("hidden");
    gameCard.classList.add("hidden");
    resultCard.classList.add("hidden");
    which.classList.remove("hidden");
  }

  function normalize(s){
    return s.trim().replace(/\s+/g, " ");
  }

  function uniqByKey(arr, keyFn){
    const seen = new Set();
    const out = [];
    for (const x of arr){
      const k = keyFn(x);
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function parseEN(text){
    const lines = text.split(/\r?\n/).map(normalize).filter(Boolean);
    const seen = new Set();
    const out = [];
    for (const w of lines){
      const k = w.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(w);
    }
    return out;
  }

  function parsePairs(text){
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const out = [];
    for (const line of lines){
      if (!line.includes("=")) continue;
      const parts = line.split("=").map(s => s.trim());
      const en = parts[0] || "";
      const ja = parts.slice(1).join("=").trim();
      if (en && ja) out.push({ en, ja });
    }
    return uniqByKey(out, x => x.en.toLowerCase());
  }

  function updateStartEnabled(){
    const items = parsePairs(pairsArea.value);
    startBtn.disabled = items.length < 4;
  }

  // ---------- Bear state ----------
  function setBearByMistakes(m){
    if (m === 0){
      bearFace.textContent = "ğŸ˜„";
      statePill.textContent = "ç¬‘é¡”ãã¾";
    } else if (m <= 2){
      bearFace.textContent = "ğŸ˜";
      statePill.textContent = "çœŸé¡”ãã¾";
    } else {
      bearFace.textContent = "ğŸ˜ ";
      statePill.textContent = "æ€’ã‚Šãã¾";
    }
  }

  // ---------- Sound ----------
  let audioCtx = null;
  function beep(freq, dur=0.12, type="sine", gain=0.06){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    g.gain.value = gain;
    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + dur);
  }

  function playWinJingle(){
    const notes = [523.25, 659.25, 783.99, 1046.50];
    let delay = 0;
    notes.forEach((f) => {
      setTimeout(() => beep(f, 0.14, "triangle", 0.07), delay);
      delay += 160;
    });
    setTimeout(() => beep(1318.51, 0.18, "triangle", 0.07), delay);
  }

  function playCorrect(){ beep(880, 0.09, "square", 0.05); }
  function playWrong(){
    beep(220, 0.12, "sawtooth", 0.06);
    setTimeout(() => beep(196, 0.12, "sawtooth", 0.06), 120);
  }

  // ---------- Confetti ----------
  function launchConfetti(){
    confetti.classList.remove("hidden");
    const canvas = confetti;
    const ctx = canvas.getContext("2d");

    const resize = () => {
      canvas.width = window.innerWidth * devicePixelRatio;
      canvas.height = window.innerHeight * devicePixelRatio;
    };
    resize();
    window.addEventListener("resize", resize, { once:true });

    const W = canvas.width, H = canvas.height;
    const N = 180;
    const parts = Array.from({length:N}, () => ({
      x: Math.random()*W,
      y: -Math.random()*H*0.3,
      vx: (Math.random()*2-1) * 1.2 * devicePixelRatio,
      vy: (Math.random()*2+2) * 1.6 * devicePixelRatio,
      r: (Math.random()*5+3) * devicePixelRatio,
      a: Math.random()*Math.PI*2,
      va: (Math.random()*0.2-0.1)
    }));

    let frames = 0;
    function tick(){
      frames++;
      ctx.clearRect(0,0,W,H);
      for (const p of parts){
        p.x += p.vx;
        p.y += p.vy;
        p.a += p.va;
        p.vy += 0.02 * devicePixelRatio;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = `hsl(${Math.floor(Math.random()*360)}, 90%, 55%)`;
        ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
        ctx.restore();

        if (p.y > H + 60*devicePixelRatio){
          p.y = -20*devicePixelRatio;
          p.vy = (Math.random()*2+2) * 1.6 * devicePixelRatio;
        }
      }
      if (frames < 140) requestAnimationFrame(tick);
      else confetti.classList.add("hidden");
    }
    tick();
  }

  // ---------- Translation ----------
  async function translateENtoJA(en){
    const url = "https://api.mymemory.translated.net/get?q=" +
      encodeURIComponent(en) + "&langpair=en|ja";
    const res = await fetch(url);
    if (!res.ok) throw new Error("API error");
    const data = await res.json();
    const t = data?.responseData?.translatedText;
    if (!t) throw new Error("no translation");
    return String(t).trim();
  }

  async function fetchTranslations(){
    warn.textContent = ""; ok.textContent = ""; progress.textContent = "";
    const list = parseEN(enInput.value);

    if (list.length < 4){
      setWarn("4èªä»¥ä¸Šå¿…è¦ã§ã™ï¼ˆãƒãƒƒãƒãƒ³ã‚°ãŒæˆç«‹ã—ãªã„ã®ã§ï¼‰");
      return;
    }
    if (list.length > 30){
      setWarn("å¤šã™ãã‚‹ã®ã§30èªä»¥å†…ã«ã—ã¦ãã ã•ã„");
      return;
    }

    fetchBtn.disabled = true;
    startBtn.disabled = true;

    const lines = [];
    for (let i=0; i<list.length; i++){
      const en = list[i];
      progress.textContent = `ç¿»è¨³ä¸­... ${i+1}/${list.length}ï¼ˆ${en}ï¼‰`;
      try{
        const ja = await translateENtoJA(en);
        lines.push(`${en} = ${ja}`);
      } catch(e){
        lines.push(`${en} = `);
      }
      await new Promise(r => setTimeout(r, 200));
    }

    pairsArea.value = lines.join("\n");
    progress.textContent = "ç¿»è¨³å®Œäº†ã€‚ç©ºæ¬„ã¯æ‰‹ã§ç›´ã—ã¦ã‹ã‚‰ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã¸ã€‚";
    setOk("OKï¼šå³ã®ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    fetchBtn.disabled = false;

    // âœ… ã“ã“ã§è‡ªå‹•ä¿å­˜ï¼ˆãƒªã‚¹ãƒˆåãŒå…¥ã£ã¦ã„ã‚Œã°ï¼‰
    autoSavePairs();
    updateStartEnabled();
  }

  // ---------- Game ----------
  function buildGame(pairs){
    currentPairs = pairs.slice();
    wrongPairs = [];
    mistakes = 0;
    matched = 0;
    selectedEN = null;
    selectedJA = null;

    scoreEl.textContent = "0";
    mistakesEl.textContent = "0";
    totalEl.textContent = String(currentPairs.length);

    setBearByMistakes(mistakes);
    hint.textContent = "è‹±èªã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ æ—¥æœ¬èªã‚’ã‚¯ãƒªãƒƒã‚¯";

    renderLists();
    reviewWrongBtn.disabled = true;
    show(gameCard);
  }

  function renderLists(){
    enList.innerHTML = "";
    jaList.innerHTML = "";

    const left = currentPairs.map((p, idx) => ({ id: "p"+idx, en:p.en, ja:p.ja }));
    const right = shuffle(left.map(x => ({...x})));

    left.forEach(item => {
      const el = document.createElement("div");
      el.className = "tile";
      el.textContent = item.en;
      el.dataset.id = item.id;
      el.dataset.side = "en";
      el.addEventListener("click", () => selectTile(el));
      enList.appendChild(el);
    });

    right.forEach(item => {
      const el = document.createElement("div");
      el.className = "tile";
      el.textContent = item.ja;
      el.dataset.id = item.id;
      el.dataset.side = "ja";
      el.addEventListener("click", () => selectTile(el));
      jaList.appendChild(el);
    });
  }

  function clearSelectionVisual(){
    [...document.querySelectorAll(".tile.selected")].forEach(el => el.classList.remove("selected"));
  }

  function markWrongFlash(el1, el2){
    el1.classList.add("wrong");
    el2.classList.add("wrong");
    setTimeout(() => { el1.classList.remove("wrong"); el2.classList.remove("wrong"); }, 350);
  }

  function markMatched(id){
    const enEl = enList.querySelector(`.tile[data-id="${id}"]`);
    const jaEl = jaList.querySelector(`.tile[data-id="${id}"]`);
    if (enEl){ enEl.classList.add("matched"); enEl.style.pointerEvents="none"; }
    if (jaEl){ jaEl.classList.add("matched"); jaEl.style.pointerEvents="none"; }
  }

  function selectTile(el){
    if (el.classList.contains("matched")) return;

    const side = el.dataset.side;
    clearSelectionVisual();
    el.classList.add("selected");

    if (side === "en") selectedEN = el;
    else selectedJA = el;

    if (selectedEN && selectedJA){
      const okMatch = selectedEN.dataset.id === selectedJA.dataset.id;

      if (okMatch){
        playCorrect();
        matched++;
        scoreEl.textContent = String(matched);
        markMatched(selectedEN.dataset.id);

        selectedEN = null;
        selectedJA = null;
        clearSelectionVisual();

        if (matched === currentPairs.length) finishGame();
        else hint.textContent = "ãƒŠã‚¤ã‚¹ï¼ æ¬¡ã‚‚ã„ã“ã†";
      } else {
        playWrong();
        mistakes++;
        mistakesEl.textContent = String(mistakes);
        setBearByMistakes(mistakes);
        hint.textContent = "ã¡ãŒã†ï¼ ã‚‚ã†ä¸€å›";

        const wrongId = selectedEN.dataset.id;
        const idx = Number(wrongId.replace("p",""));
        const pair = currentPairs[idx];
        wrongPairs.push(pair);
        wrongPairs = uniqByKey(wrongPairs, x => x.en.toLowerCase());

        markWrongFlash(selectedEN, selectedJA);

        selectedEN = null;
        selectedJA = null;
        clearSelectionVisual();
      }
    }
  }

  function finishGame(){
    if (mistakes === 0){
      setBearByMistakes(0);
      launchConfetti();
      playWinJingle();
      hint.textContent = "æº€ç‚¹ï¼ï¼ğŸ‰";
    } else {
      hint.textContent = "ã‚¯ãƒªã‚¢ï¼";
    }

    const reviewSet = wrongPairs.slice(0, 10);
    reviewWrongBtn.disabled = reviewSet.length < 4;
    setTimeout(showResult, mistakes === 0 ? 800 : 250);
  }

  function showResult(){
    show(resultCard);
    const total = currentPairs.length;
    resultText.textContent = `æ­£è§£ ${total} / ${total}ï¼ˆãƒŸã‚¹ ${mistakes}ï¼‰`;

    const reviewSet = wrongPairs.slice(0, 10);
    if (wrongPairs.length === 0){
      wrongBox.innerHTML = "<p>ã¾ã¡ãŒãˆãŸå˜èªã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰</p>";
      retryWrongBtn.disabled = true;
    } else {
      retryWrongBtn.disabled = reviewSet.length < 4;
      const items = wrongPairs.map(p => `<li>${escapeHtml(p.en)} = ${escapeHtml(p.ja)}</li>`).join("");
      wrongBox.innerHTML = `<p><b>ã¾ã¡ãŒãˆãŸå˜èªï¼ˆå¾©ç¿’ç”¨ï¼‰</b></p><ul>${items}</ul>
        <p class="muted">â€»ã€Œã¾ã¡ãŒãˆãŸå˜èªã ã‘å¾©ç¿’ã€ã¯æœ€å¤§10å€‹ã€‚4å€‹æœªæº€ã ã¨å…¨ä½“ã«æˆ»ã—ã¾ã™ã€‚</p>`;
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ---------- Buttons ----------
  sampleBtn.addEventListener("click", () => {
    enInput.value =
`compromise
contaminate
define
deflect
demolish
endorse
forfeit
hinder
loiter
modify
prosper
provoke
reciprocate
relocate
resent`;
  });

  fetchBtn.addEventListener("click", fetchTranslations);

  // âœ… pairsArea ã‚’ç›´ã—ãŸã‚‰ï¼šé–‹å§‹å¯å¦ãƒã‚§ãƒƒã‚¯ï¼‹è‡ªå‹•ä¿å­˜
  pairsArea.addEventListener("input", () => {
    updateStartEnabled();
    autoSavePairs();
  });

  // âœ… ãƒªã‚¹ãƒˆåã‚’æ‰“ã£ã¦ã‚‹æœ€ä¸­ã‚‚ã™ãåæ˜ ï¼ˆchangeâ†’inputï¼‰
  listNameInput.addEventListener("input", () => {
    const name = listNameInput.value.trim();
    if (!name){
      // åå‰ã‚’æ¶ˆã—ãŸã ã‘ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆä¿å­˜ã‚‚ã—ãªã„ï¼‰
      refreshSavedUI();
      return;
    }
    const saved = loadPairsByName(name);
    if (saved != null && pairsArea.value.trim() === ""){
      // æ–°è¦å…¥åŠ›ä¸­ã§å³ãŒç©ºã®ã¨ãã ã‘è‡ªå‹•å¾©å…ƒï¼ˆã†ã£ã‹ã‚Šä¸Šæ›¸ãé˜²æ­¢ï¼‰
      pairsArea.value = saved;
      setOk(`ã€Œ${name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      updateStartEnabled();
    }
    saveLastName(name);
    refreshSavedUI(name);
  });

  // âœ… ä¿å­˜æ¸ˆã¿ä¸€è¦§ã‹ã‚‰èª­ã¿è¾¼ã¿
  loadSavedBtn.addEventListener("click", () => {
    const name = savedSelect.value.trim();
    if (!name) return;
    const saved = loadPairsByName(name);
    if (saved == null){
      setWarn(`ã€Œ${name}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      refreshSavedUI();
      return;
    }
    applyLoaded(name, saved);
    setOk(`ã€Œ${name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  });

  // âœ… å‰Šé™¤
  deleteSavedBtn.addEventListener("click", () => {
    const name = savedSelect.value.trim();
    if (!name) return;
    const okDel = confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰`);
    if (!okDel) return;

    localStorage.removeItem(keyFor(name));
    // lastãŒã“ã®åå‰ã ã£ãŸã‚‰æ¶ˆã™ï¼ˆã¾ãŸã¯ç©ºã«ï¼‰
    const last = localStorage.getItem(KEY_LAST);
    if (last === name) localStorage.removeItem(KEY_LAST);

    // è¡¨ç¤ºæ›´æ–°
    if (listNameInput.value.trim() === name){
      listNameInput.value = "";
      pairsArea.value = "";
      updateStartEnabled();
    }
    refreshSavedUI();
    setOk(`å‰Šé™¤ã—ã¾ã—ãŸï¼š${name}`);
  });

  // âœ… Exportï¼ˆã“ã®ãƒªã‚¹ãƒˆï¼‰
  exportOneBtn.addEventListener("click", () => {
    const name = savedSelect.value.trim();
    if (!name) return;
    exportOne(name);
  });

  // âœ… Exportï¼ˆå…¨éƒ¨ï¼‰
  exportAllBtn.addEventListener("click", exportAll);

  // âœ… Import
  importBtn.addEventListener("click", () => importFile.click());

  importFile.addEventListener("change", async () => {
    warn.textContent = ""; ok.textContent = "";
    const file = importFile.files?.[0];
    importFile.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«é€£ç¶šé¸æŠå¯¾ç­–
    if (!file) return;

    const text = await file.text();
    const baseName = file.name.replace(/\.[^.]+$/, ""); // æ‹¡å¼µå­ãªã—
    // JSONã‚’è©¦ã™
    try{
      const obj = JSON.parse(text);
      importPayload(obj, baseName);
      refreshSavedUI(listNameInput.value.trim());
      return;
    } catch(e){
      // txtæ‰±ã„ï¼ˆpairsãƒ†ã‚­ã‚¹ãƒˆï¼‰
    }
    // txtï¼šãã®ã¾ã¾pairsAreaã¸ã€‚åå‰ãŒç©ºãªã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ã†
    const name = listNameInput.value.trim() || baseName;
    if (!name){
      setWarn("Importå¤±æ•—ï¼šãƒªã‚¹ãƒˆåãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    localStorage.setItem(keyFor(name), text);
    applyLoaded(name, text);
    setOk(`Importã—ã¾ã—ãŸï¼š${name}`);
  });

  startBtn.addEventListener("click", () => {
    warn.textContent = ""; ok.textContent = "";
    const pairs = parsePairs(pairsArea.value);
    if (pairs.length < 4){
      setWarn("4èªä»¥ä¸Šã€Œè‹±èª = æ—¥æœ¬èªã€ã§ãã‚ãˆã¦ãã ã•ã„ï¼ˆç©ºæ¬„ãŒã‚ã‚‹ã‹ã‚‚ï¼‰");
      return;
    }
    basePairs = pairs.slice();
    buildGame(basePairs);
  });

  resetBtn.addEventListener("click", () => show(setupCard));

  shuffleBtn.addEventListener("click", () => {
    selectedEN = null; selectedJA = null;
    renderLists();
    hint.textContent = "ä¸¦ã¹ç›´ã—ãŸã‚ˆ";
  });

  playAgainBtn.addEventListener("click", () => buildGame(basePairs));

  reviewWrongBtn.addEventListener("click", () => {
    const set = wrongPairs.slice(0, 10);
    if (set.length >= 4) buildGame(set);
    else buildGame(basePairs);
  });

  retryAllBtn.addEventListener("click", () => buildGame(basePairs));

  retryWrongBtn.addEventListener("click", () => {
    const set = wrongPairs.slice(0, 10);
    if (set.length >= 4) buildGame(set);
    else buildGame(basePairs);
  });

  backBtn.addEventListener("click", () => show(setupCard));

  // âœ… èµ·å‹•æ™‚ï¼šå‰å›ã®ãƒªã‚¹ãƒˆåï¼‹å†…å®¹ã‚’è‡ªå‹•å¾©å…ƒ ï¼‹ ä¸€è¦§æ›´æ–°
  window.addEventListener("DOMContentLoaded", () => {
    refreshSavedUI();

    const last = localStorage.getItem(KEY_LAST);
    if (last){
      listNameInput.value = last;
      const saved = loadPairsByName(last);
      if (saved){
        pairsArea.value = saved;
        savedSelect.value = last;
      }
    }
    refreshSavedUI(listNameInput.value.trim());
    updateStartEnabled();
  });

})();
</script>
</body>
</html>
